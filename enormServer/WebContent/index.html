<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	style="width:100%; height:100%;"
	>
<head>
<title>Enorm repository viewer</title>
<meta charset="utf-8">
<script src="https://d3js.org/d3.v4.js"></script>
<script type="text/javascript" src="jsog.js"></script>
<script type="text/javascript" src="enorm.js"></script>
<style>
.options-box {
	opacity: 1;
	top: 1%;
	left: 10%;
	position: absolute;
	z-index: 3;
	background:white;
	font-size: 14px;	
	color: darkblue;
	font-weight: bold;	
	line-height: 30px;
	text-align: left;
	border: 2px;
	border-style: outset;
	padding:5px;
}
.options-box div {
margin-left:8px;
}
.options-box label {
	display: block;
		
}
.waiting-screen {
	top:0;
	z-index:2;
	width:100%;
	height:100%;
	background:gray;
	opacity: 0.6;
	position:fixed;
	font-size: 25px;
	text-align: center;
	line-height: 10;
	color: darkblue;
	font-weight: bold;
}
.footer-method {
	display:block;
}
.closeClassIcon {
	fill:gray;	
}
.main-desc {
}
.mapping-desc {

}
.mapping-desc-more {
	display:none;
}
.prop-mapping-desc {

}
.prop-mapping-desc-more {
	display:none;
}
.closeClassIcon:hover {
	fill:red;	
}
.footer button:disabled {
	background: none;
	border: none;
	color: inherit;
	font: inherit;
}
.footer {
	position: fixed;
    bottom: 0;
    width: 100%;
    z-index: 2; /* Stay on top */
    background-color: #D2DC34;
   	border-style:outset;
   	border-color: whitesmoke;
 	opacity: 0.8;
}
.footer tr {
	vertical-align: top;
}
.footer tr td {
	padding: 5px;
}
.footer-interface {
}
.svg_main {
	position:fixed;
	top:0; 
	left:0;

}
.node {
   
}
.more-button {
	text-decoration:underline;
	cursor:pointer;
	fill:blue;
	color:blue;
}

.active {
  fill-opacity: 0.4;
  stroke-width: 3px;
}

.active_link {
  stroke-opacity: 0.4;  
}
.persistent {
	fill: rgb(176,224,176);
}
.transient {
	fill: rgb(249,241,178);
}
.node-interface {
	fill: rgb(255,255,255);
}

.link {
    fill: none;
}

.link_title {    
	font: 12px sans-serif;
    
}
.link_title_inv {    
	font: 12px sans-serif;
    
}
.text_property{
}
.text_title{
}
.title_line {
}
.sidenav {
    height: 100%; /* 100% Full-height */
    width: 0; /* 0 width - change this with JavaScript */
    position: fixed; /* Stay in place */
    z-index: 1; /* Stay on top */
    top: 0;
    left: 0;
    background-color: #111; /* Black*/
    overflow-x: hidden; /* Disable horizontal scroll */
    /*padding-top: 60px;*/ /* Place content 60px from the top */
    padding: 0px;
    transition: 0.5s; /* 0.5 second transition effect to slide in the sidenav */
}
.openbtn {
	border-style: none;
	background-color: lightblue;
	z-index: 1;
	position:relative;
}
@media only screen and (max-device-width: 680px) {
.openbtn {
	font-size:20px;	
	}
}
/* The navigation menu links */
.sidenav a {
    padding: 4px 4px 4px 12px;
    text-decoration: none;
    font-size: 18px;
    color: #818181;
    display: block;
    transition: 0.3s
}

/* When you mouse over the navigation links, change their color */
.sidenav a:hover, .offcanvas a:focus{
    color: #f1f1f1;
}
.sidenav .current_menu {
	color: #f1f1f1;
}

/* Position and style the close button (top right corner) */
.sidenav .closebtn {
	border-style: none;
	background-color: lightblue;
	color: white;
    position: absolute;
    top: 0;
    right: 5px;
    font-size: 16px;
    margin-left: 15px;
}
body {
	margin:0px;
}
/* Style page content - use this if you want to push the page content to the right when you open the side navigation */
#main {
    transition: margin-left .5s;
    padding: 20px;
}

/* On smaller screens, where height is less than 450px, change the style of the sidenav (less padding and a smaller font size) */
@media screen and (max-height: 450px) {
    .sidenav {padding-top: 15px;}
    .sidenav a {font-size: 18px;}
}
ul.tree, ul.tree ul {
    list-style-type: none;
	color:white;
	margin: 0;
    padding: 0;
}
ul.tree ul {
	margin-left: 10px;
}

ul.tree li {
	margin: 0;
	padding: 0 12px;
}

ul.tree li p {
	margin: 0;
	color: #818181;
}
ul.tree li a {
	margin: 0;
	padding: 0 0px;	
}
.hidden_btn {
	display:none;
}
    </style>
</head>
<body style="width:100%; height:100%;">
<div id="mySidenav" class="sidenav">
  <div style="width:100%;height:30px;"></div>
  <!--<button class="closebtn" onclick="closeNav()">&lt;&lt;</button>  -->
</div>
<button class="openbtn" id="navbutton" onclick="openNav()">>></button>
<button class="openbtn" onclick="zoomIn()" title="zoom in">+</button>
<button class="openbtn" onclick="zoomOut()" title="zoom out">-</button>
<button class="openbtn" style="display:none" onclick="retrieveRepo()">o</button>
<button class="openbtn" onclick="loadDefaultRepo()" title="reload example">☉</button>
<button class="openbtn" onclick="processRepo()" title="enter repository to crawl">...</button>
<button class="openbtn" onclick="testAuth()" title="login at github">auth</button>
<button class="openbtn" onclick="saveModel()" title="save diagrams on cache">✍</button>
<button class="openbtn" onclick="refreshSVG()" title="resize elements">↭</button>
<button class="openbtn" onclick="showMappings()" title="show/hide mappings">M</button>




<div id="main" style="padding: 0px;">

</div>
<script>
function saveModel() {
	var txt = JSOG.stringify(model);
	setStorage("model",txt);
}
function testAuth() {
	window.open("Auth?start=1","_self");	
}

function loadRepo(new_repo) {
	repo = new_repo;
	model = new Model(repo);
	cleanDiagram();	
 	/*repo.classes.sort(function(a,b) {
		if (a.name < b.name)
	    	return -1;
	  	if (a.name > b.name)
	    	return 1;
	  	return 0;
 	});*/
 	startup();
}

function processRepo() {
	var rname = prompt("Please enter repository name", "alexandretorres/ghubenorm");
	if (!rname) {		
		return;
	}
	
    d3.select("body").append("div").attr("class","waiting-screen")
    	.text("The server is crawling... it may take a few minutes.")
    	.append("svg")	
    	.style("vertical-align","bottom")
		.append("use")
		.attr("width",40)
		.attr("height",40)		
		.attr("xlink:href","#loader-1");
    var smodel = getStorage("model");
    
    if (smodel!=null && smodel.length>0) {
    	var c_model = JSOG.parse(smodel);
    	var c_repo=c_model.repo;
    	if (c_repo.name == rname) {    		
    		cleanDiagram();	
    		repo=c_repo;
    		model=c_model;
    		startup();
    		d3.selectAll(".waiting-screen").remove();
    		return;
    	}    		
    }    
	d3.text("ProcessRepo?name="+rname, function (err, txt) {
		d3.selectAll(".waiting-screen").remove();
		
		if (err) {
			if (err.srcElement) {
				alert("Error: "+err.srcElement.responseText);
			}else if (err.currentTarget) {
				alert("Error: "+err.currentTarget.responseText);
			} else {
				alert("error loading "+err);
			}
			return;
		}
		//setStorage("repo",txt);
		n_repo = JSOG.parse(txt);		
		loadRepo(n_repo);
		setStorage("model",model);
	});
}
function retrieveRepo() {
	var pid = prompt("Please enter repository public id", "2668610");
	d3.text("RetrieveRepo?pid="+pid, function (err, txt) {
		if (err) {
			alert("error loading "+err);
			return;
		}
		cleanDiagram();
		repo = JSOG.parse(txt);
	 	repo.classes.sort(function(a,b) {
			if (a.name < b.name)
		    	return -1;
		  	if (a.name > b.name)
		    	return 1;
		  	return 0;
	 	});
	 	model = new Model(repo);
	 	startup();
	});

}
function zoomIn() {
	w=w-(w/10);
	h=h-(h/10);
	svg.attr("viewBox",function(d) {
		return "0 0 "+w+" "+ h;
		});
}
function zoomOut() {
	w=w+(w/10);
	h=h+(h/10);
	svg.attr("viewBox",function(d) {
		return "0 0 "+w+" "+ h;
		});
}

function toggleOption(d,i) {
	d.toggle();	
	
}
function showMappings() {
	d3.select("body").append("div").attr("class","waiting-screen");
	var optDiv = d3.select("body").append("div")
		.attr("class","options-box")
		.attr("id","options").append("div")
		;
	optDiv./*append("table").*/selectAll("input[type='checkbox']")
		.data(options).enter()/*.append("tr").append("td")*/.append("label")
		.text(function (d) {return d.desc} )
		.append("input").attr("type","checkbox")
		.property("checked",function (d) {return d.active;} )
		.attr("id",function (d) {return "cb_"+d.name;} )
		.on("click",toggleOption)
		;
	var pp = optDiv.append("span");
	pp.append("button").text("Close").on("click",function(d) { 
		d3.selectAll(".waiting-screen").remove();
		d3.selectAll(".options-box").remove();
		
	});
	//pp.append("button").text("Cancel");
}
function isOpenNav() {
	return document.getElementById("mySidenav").style.width=="250px";
}
/* Set the width of the side navigation to 250px and the left margin of the page content to 250px */
function openNav() {
	if (document.getElementById("mySidenav").style.width!="250px") {
		document.getElementById("navbutton").innerHTML="&lt;&lt;";
		document.getElementById("mySidenav").style.width = "250px";
		document.getElementById("main").style.marginLeft = "250px";
	} else {/* Set the width of the side navigation to 0 and the left margin of the page content to 0 */
		document.getElementById("navbutton").innerHTML="&gt;&gt;";
		document.getElementById("mySidenav").style.width = "0px";
		document.getElementById("main").style.marginLeft = "0px";
	}
}

function openSource() {
	if (currentClass!=null) {		
		window.open(currentClass.clazz.filePath.replace("/raw/","/blob/").replace("file:/","[file:]"));
	}
}

var repo;// = JSOG.parse(js);
var w = 800;
var h = 600;
var sy=15;
var PropHeight=15;
var svg = d3.select("#main")
            .append("svg")
			.attr("class","svg_main")
            .attr("width", "100%")
            .attr("height", "100%")
			.attr("viewBox","0 0 800 600");
var defs = svg.append("defs");
defs.append("marker")	
	.attr("id","arrow-end")
	.attr("viewBox", "0 0 10 10")
    .attr("refX", 10)
    .attr("refY", 3)
    .attr("markerWidth", 10)
    .attr("markerHeight", 10)
    .attr("orient", "auto")
	.append("path")	
	.attr("d", "M0,6 L9,3 L0,0 ")
	.style("stroke", "black")
	.style("fill","none")
	.style("stroke-width", 1);	
defs.append("marker")	
	.attr("id","arrow-start")
	.attr("viewBox", "0 0 10 10")
    .attr("refX", 0)
    .attr("refY", 3)
    .attr("markerWidth", 10)
    .attr("markerHeight", 10)
    .attr("orient", "auto")
	.append("path")	
	.attr("transform","translate(10), scale(-1, 1)")
	.attr("d", "M0,6 L9,3 L0,0 ")
	.style("stroke", "black")
	.style("fill","none")
	.style("stroke-width", 1);	
defs.append("marker")	
	.attr("id","extends")
	.attr("viewBox", "0 0 10 10")
    .attr("refX", 10)
    .attr("refY", 3)
    .attr("markerWidth", 10)
    .attr("markerHeight", 10)
    .attr("orient", "auto")
	.append("path")	
	.attr("d", "M0,0 L0,6 L9,3 z")
	.style("stroke", "black")
	.style("fill","white")
	.style("stroke-width", 1);
//d3.xml('extras.svg', "image/svg+xml", function(xml){
d3.xml('extras.svg').mimeType("image/svg+xml").get(function(error, xml) {
	if (error) throw error;
		//var importedNode = document.importNode(xml.documentElement, true).getElementById("gflat_inheritance")[0];
	var docNode = document.importNode(xml.documentElement, true);
	var importedNode = docNode.getElementById("gflat_inheritance");
	
	defs.append("marker")	
	.attr("id","flat_inheritance")
	.attr("viewBox", "0 0 20 20")
    .attr("refX", 20)
    .attr("refY", 10)
    .attr("markerWidth", 10)
    .attr("markerHeight", 10)	
    .attr("orient", "auto")    
	.node().appendChild(importedNode);
		
	var importedVert = docNode.getElementById("gvertical_inheritance");
	defs.append("marker")	
	.attr("id","vert_inheritance")
	.attr("viewBox", "0 0 20 20")
    .attr("refX", 20)
    .attr("refY", 10)
    .attr("markerWidth", 10)
    .attr("markerHeight", 10)
	
    .attr("orient", "auto")
	.node().appendChild(importedVert);
	
	var importedHoriz = docNode.getElementById("ghorizontal_inheritance");
	
	defs.append("marker")	
	.attr("id","horiz_inheritance")
	.attr("viewBox", "0 0 20 20")
    .attr("refX", 20)
    .attr("refY", 10)
    .attr("markerWidth", 10)
    .attr("markerHeight", 10)
	
    .attr("orient", "auto")
	.node().appendChild(importedHoriz);
	
	var closeNode = docNode.getElementById("open-iconic-x");
	defs.node().appendChild(closeNode);
	var loading =  docNode.getElementById("loader-1");
	defs.node().appendChild(loading);
	
});


d3.selection.prototype.moveToFront = function() {
  return this.each(function(){
    this.parentNode.appendChild(this);
  });
};
d3.selection.prototype.moveToBack = function() { 
    return this.each(function() { 
        var firstChild = this.parentNode.firstChild; 
        if (firstChild) { 
            this.parentNode.insertBefore(this, firstChild); 
        } 
    }); 
};

//var fdata = {nodes:[],links:[],ndata:[],ldata:[]};
var model;
var footerElement;
var centralClass;
var currentClass;
var classes;

{
	var txt = getStorage("model");
	if (txt!=null && txt.length>0)
		try {
			model = JSOG.parse(txt);
			repo = model.repo;
			startup();
		} catch (e) {
			alert("model could not be retrieved from cache");
		}
}

if (!model) {
	loadDefaultRepo();
}
function loadDefaultRepo() {
	d3.text("data.txt", function (err, txt) {
		 repo = JSOG.parse(txt);
		 repo.classes.sort(function(a,b) {
			if (a.name < b.name)
		    return -1;
		  if (a.name > b.name)
		    return 1;
		  return 0;
		 });
		 model = new Model(repo);
		 startup();
		});
}
function reDrawMenu() {
	repo.classes.sort(model.getSortFunction());	

	d3.select("#mySidenav").selectAll("ul").data([]).exit().remove();	
	var sideMenu = d3.select("#mySidenav").append("ul").attr("class","tree").selectAll("li")
		.data(repo.classes).enter()
		.append("li");
	var last="";
	sideMenu.filter(function(d) { 
			if ( d.packageName==null)
				return false;
			if (last!=d.packageName) {
				last = d.packageName;
				return true;
			}
			return false;
		})	
		.append("p")		
		.style("font-size","9px")
		.attr("title",function(d) {
			return d.packageName;
		})
		.text(function(d) {
			return d.packageName;
		});
	var menuLinks = sideMenu.append("a")
		.attr("href","#")
	//	.attr("font-style", function(d) {return d.getFontStype()})
		.attr("title",function(d) {
			return d.fullName;
		})
		.classed("current_menu",function(d) {return d==centralClass})
		//d3.select(this).classed("current_menu",true);	

		
		.on("click",pickClass)		
		.text(function(d) {
			return d.name
		});	
}
function startup() {
	reDrawMenu();
	if (!isOpenNav())
		openNav();
	
	var login = getCookie("login");
	if (login) {
		d3.select("title").text("Enorm repository viewer for "+login);
	}

}
function cleanDiagram() {
	svg.selectAll('.node')
		.data([]).exit().remove(); //exit is positional to data. Difficult to keep the classes
	svg.selectAll('.link').data([]).exit().remove();
	svg.selectAll('.link_title').data([]).exit().remove();
	svg.selectAll('.link_title_inv').data([]).exit().remove();
}
function pickClass(d,i) {	
	d3.select(".current_menu").classed("current_menu",false);	

	d3.select(this).classed("current_menu",true);	

	centralClass = repo.classes[i];	
	selectClass(null);
	model.showDiag(centralClass);
	//findClasses(centralClass);
	cleanDiagram();
	drawModel();
}


// ⇑ ⇧ ↑ 
function className(d) {
	var tx = d.name;
	if (d.persistent) {
		tx+=" || ";	
		if (d.persistence.source!=null) 
			tx=tx+printDSName(d.persistence.source);	
	}	
	return tx;
}
function printPropDesc(p,assoc=false) {
	var pname="";
	//prefix
	
	if (p.pk) {
		pname+="<PK>";
	} else if (p.transient)
		pname+="θ ";
	if (p.embedded) 
		pname+="<Embed>";
	if (p.derived)
		pname+="/ ";
	if (p.generated.generated) {
		pname+="<Gen>";
		if (p.generated.type!=null) {
			pname+="("+p.generated.type+")";
		}
	}
	if (pname.length>0)
		pname+=" ";
	//-- name, cardinality
	pname+=p.name;
	if ((p.min==0 && p.max<0) || (p.min==1 && p.max==1))
		pname+=	" ["+(p.max<0 ? "*": p.max)+"]";
	else
		pname+=	" ["+p.min+".."+(p.max<0 ? "*": p.max)+"]";
	if (!assoc)
		pname+=": "+ coalesce(p.type,"<<unknown>>");
	else
		pname+=" ";
	return pname;
}
function getPropDesc(p,assoc=false) {
	var pname = printPropDesc(p,assoc);
	// mapping
	if (p.columnMapping!=null) {
		pname+=" || ";
		var mainTab = p.parent.persistence.mainTable;
		pname+=printColumn(mainTab,p.columnMapping.columnDefinition);
	}
	return pname;
}
function printColumnExtra(mainTab,col) {
	var ret="";	

	if (col.column.insertable!=null)
		ret+="{ins="+col.column.insertableDef+"}";
	if (col.column.updatable!=null)
		ret+="{upd="+col.column.updatableDef+"}";
	if (col.column.unique!=null)
		ret+="{uniq="+col.column.uniqueDef+"}";
	return ret;
}
function printColumn(mainTab,col) {
	
	var ret = mainTab==null || col.table==null || col.table.name==mainTab.name ? "" : col.table.name+".";
	if (col.name!=null)
		ret+=col.name;
	if (col.columnDefinition!=null && col.columnDefinition.length>0)
		ret+=":"+col.columnDefinition;
	if (col.column.length!=null)
		ret+="("+col.lengthDef+")";
	else if (col.column.precision!=null || col.column.scale!=null) {
		ret+="(";
		if (col.column.precision) {
			ret+=col.column.precisionDef;
			if (col.column.scale)
				ret+=", "+col.column.scaleDef;
		} else 
			ret+="?, "+col.column.scaleDef;
		ret+=")";
		
	}
	if (col.column.defaultValue!=null)
		ret+="def="+col.column.defaultValue;
	if (col.column.nullable!=null)  // make isCheckers public on MColumn.
		ret+=col.nullableDef ? "{nullable}" : "{not null}";
	return ret;
}
function printDSName(ds) {
	if (ds==null)
		return null;
	if (ds.defines!=null) {
		var ret="";
		
		for (var tab of ds.defines) {
			var tname = tab.name;
			if (ret.length>0)
				ret+=",";
			ret+=tname==null ? "<Unnamed>" : tname;
		}
		return ret;
	} else
		return ds.name;
}
function printAssociationDef(/*MAssociationDef*/ adef,/*MClass*/ cl,/*MProperty*/ p) {
	var ret="";
	if (adef!=null) {
		var dsName=null;
		if (adef.dataSource!=null && (dsName=printDSName(adef.dataSource))!=null) {
			ret+="joinTable="+dsName;			
		}		
		var txJcs = printJoinColumns(adef.joinColumns,cl,p.typeClass,p);
		if (ret!="" && txJcs!=null)
			ret+=",";
		ret+=txJcs;
		if (adef.cascade!=null)
			ret+="cascade "+adef.cascade;
		if (adef.orphanRemoval!=null)
			if (adef.orphanRemoval)
				ret+=" orphan remove ";
			else
				ret+=" keep orphans  ";
		if (adef.fetch!=null)
			ret+=" fetch "+adef.fetch;
	}
	if (ret.length>0)
		ret="{"+ret+"}";
	return ret;
}

function printJoinColumnName(type,c,p) {	
	if (c.name!=null)
		return c.name;
	var id=null;	
	if (type!=null && type.pk.length>0) {
		id = type.pk[0].name;
	}
	if (id==null) {
		id="id";
	}
    var sufix = p ? "<"+p.name+"_" : "<";
	return sufix+id+">";
}

function getAssociation(prop) {
	var ret = prop.association;
	return ret==null ?  prop.toAssociation : ret;
}
function getInverse(prop) {
	var a = getAssociation(prop);
	if (a==null)
		return null;
	return (a.to==prop) ? a.from : a.to;
}
function printAssocEndDesc(p) {
	return getPropDesc(p,true)+printAssociationDef(p.associationDef,p.parent,p); 
}
function drawAssocEndDesc(p,ctx) {
	var parent=d3.select(ctx);
	var tx = getPropDesc(p,true);
	parent.append("tspan")
		.attr("class","main-desc")
		.text(tx);
		//.text(function (p) {return getPropDesc(p,true)});//.mapping-desc .more-desc
	tx=printAssociationDef(p.associationDef,p.parent,p);
	if (tx) {
		parent.append("tspan")
		.attr("class","mapping-desc")
		.text(tx);
		parent.append("tspan")
		.attr("class","mapping-desc-more")
		.text("...");
	}
}
function hasInvisibleGeneralizations(c) {
	var fdata = model.diagram;	

	if (c!=null && c.superClass) {
		if (fdata.indexOfClass(c.superClass)<0)
			return true;
		var pos = fdata.indexOfClass(c);
		return fdata.links.filter(function(d){
	  		return d.source==pos && d.type=="G";
		}
		).length==0;
	}
	return false;
}
function showSubClass(sub) {
	var fdata = model.diagram;	

	d3.event.stopPropagation();
	var psource = fdata.indexOfClass(sub);
	var subNode;
	var ptarget = fdata.nodes.indexOf(currentClass);
	if (psource>=0) {
		subNode = fdata.nodes[psource]	;
	
	//console.log("add sub "+sub.name+" selected "+currentClass.name);
		var lnks = fdata.links.filter(function(d){
	  		return d.source==psource && d.target==ptarget && d.type=="G";
		}
		);
		if (lnks.length>0) {
			return;
		}		
	} else {
		subNode = new Node(sub);	
		fdata.nodes.push(subNode);
	}
	
	var gen = sub.generalization.length>0 ? sub.generalization[0] : null;
	var exts = [{type:"G",source:fdata.nodes.indexOf(subNode),target:fdata.nodes.indexOf(currentClass),prop:gen}];
	fdata.links = fdata.links.concat(exts);	
	drawModel();	
}
function clickShowExtends(c) {
	d3.event.stopPropagation();
	var fdata = model.diagram;
	var supNode;
	var idx = fdata.indexOfClass(c.clazz.superClass);
	if (idx<0) {
		supNode=new Node(c.clazz.superClass);
		fdata.nodes.push(supNode);
	} else
		supNode = fdata.nodes[idx];
	var gen = c.clazz.generalization.length>0 ? c.clazz.generalization[0] : null;
	var exts = [{type:"G",source:fdata.nodes.indexOf(c),target:fdata.nodes.indexOf(supNode),prop:gen}];
	fdata.links = fdata.links.concat(exts);	
	drawModel();	
	d3.select(this).attr("disabled","disabled");
}
function clickProperty(p) {
	d3.event.stopPropagation();	
	var fdata = model.diagram;
	if (p.typeClass!=null) {
		var n;	
		var idx = fdata.indexOfClass(p.typeClass);
		if (idx<0) {
			n = new Node(p.typeClass);
			idx = fdata.nodes.push(n)-1;	
		} else {
			n = fdata.nodes[idx];
		}
		if (fdata.links.filter(function(d){
			  		return d.prop==p;
				}
				).length==0) {
			var type = p.embedded ? "E" : "A";	
		
			fdata.links.push(
					{type:type,source:fdata.indexOfClass(p.parent),target:idx,prop:p}
			);
		}
		var nclass = d3.select(this.parentNode.parentNode);
		drawProperties(nclass);
		drawModel();			
		
	}
}

function drawModel() {
	var cls = model.diagram.nodes;
	var fdata = model.diagram;
	var grid = [[w/2,h/2],[w/2+100,h/2],[w/2,0],[0,h/2],[w/2,h/2+100],[w/2+100,h/2+100],[0,h/2+100],[w/2+100,0],[0,0]];
	var clazzBox = svg.selectAll('.node')
		.data(cls).enter();
	clazzBox= clazzBox
		.append("svg")		
		.attr("x",function(d,i) { 
			if (fdata.reposition || d.x==null) {				
				if (i<grid.length)
					d.x= grid[i][0];
				else
					d.x = 0;
			} 
			return d.x;
		})
		.attr("y",function(d,i) { 
			if (fdata.reposition  || d.y==null) {		
				if (i<grid.length)
					d.y= grid[i][1];
				else
					d.y = 0;
			}
			return d.y;
		})
		.attr('class', 'node');		
	
	var titleTx = clazzBox.append("text")
		.attr('xml:space', "preserve")
		.text(function(d) {return "    "+className(d.clazz)+"    "})
		.attr('class','text_title')
		.attr("text-anchor","middle")
		//.attr("alignment-baseline","central")
		.attr("font-family", "sans-serif")
		.attr("font-size", "12px")
		.attr("font-weight", "bold")
		.attr("font-style", function(d) {return d.getFontStype()})
		.attr("fill", "black")
		.attr("x",  function(d) {return this.getBBox().width/2;} )  // very important to start in the middle! or bbox goes crazy
		.attr("y", function(d, i) {
			return sy;
		})
		;
	//todo: auto-rel
	drawProperties(clazzBox);
		
	clazzBox.append("line")
		.attr("class","title_line")
		.attr("stroke-width",1)
		.attr("stroke","black")
		.attr('x1', 0)
		.attr('y1', function(d) {
			var titTx = d3.select(this.parentElement).select(".text_title");
			return titTx.node().getBBox().height+sy/2-1;
			})
	//	bbox1.height+sy/2-1)
		.attr('x2', function(d) {return this.parentElement.getBBox().width})
		.attr('y2',function(d) {
			var titTx = d3.select(this.parentElement).select(".text_title");
			return titTx.node().getBBox().height+sy/2-1;
			});
		//.attr('y2', bbox1.height+sy/2-1).moveToBack();
	titleTx.attr('x',function(d) {return this.parentElement.getBBox().width/2});
	//clazzBox.selectAll().node().children()
	
	clazzBox.call(d3.drag()
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", dragended));

	addBox(clazzBox);
	
	clazzBox.append("g")
		.on("mousedown",closeClass)
		.append("use")
		.attr("class","closeClassIcon")
		.attr("y",2)
		.attr("x", 0 )
		.attr("width",10)
		.attr("height",10)		
		.attr("xlink:href","#open-iconic-x")
		;
	//links
	var link = svg.selectAll(".link")
		.data(fdata.links)
		.enter().append("path")
		.attr("class", "link")
		.attr("stroke-width",1)
		.attr("stroke","black")	
		.style("stroke-width", function(d) {			
			if (d.type=="G") 
				return 2;
			else
				return 1
			})
		.attr("marker-end",function(d) {
			if (d.type=="A" || d.type=="E")
				return "url(#arrow-end)";
			if (d.type=="G") {
				if (d.prop==null)
					return "url(#extends)";
				else if (d.prop._Type=="MVertical")
					return "url(#vert_inheritance)";	
				else if (d.prop._Type=="MHorizontal")
					return "url(#horiz_inheritance)";	
				else if (d.prop._Type=="MFlat")
					return "url(#flat_inheritance)";						
			}
			return null;
		})		
		.attr("marker-start",function(d) {
			if (d.type=="A") {				
				if (getInverse(d.prop)!=null)
					return "url(#arrow-start)"
			}
			return null;
			});
	link.append("title").text(function (d) {
		if (d.type=="A") 
			return "association";
		else if (d.type=="E")
			return "an embedded/dependent association";
		else if (d.type=="G") {
			if (d.prop==null)
				return "extends";
			else if (d.prop._Type=="MVertical")
				return "extends using Vertical mapping (joined tables)";	
			else if (d.prop._Type=="MHorizontal")
				return "extends using Horizontal mapping (one table per persistent class)";	
			else if (d.prop._Type=="MFlat")
				return "extends using Flat mapping (a single table with a discriminator column)";						
		}
		return "?";
		});
	
		
		
	var linkTitles = svg.selectAll(".link_title")
		.data(fdata.links)
		.enter()
		.append("text")
		.attr("text-anchor","end") //at the end /start
		//.attr("dominant-baseline","central")
		.attr("class","link_title")
	/*	.text(function(d) {
			if (d.type=="G") {
				var targ = fdata.nodes[d.target].clazz;
				
				return targ.printDiscriminator();
			} else				
				return printAssocEndDesc(d.prop);
		})*/;
	linkTitles.each(function (d) { 
		if (d.type=="G") {
			var targ = fdata.nodes[d.target].clazz;
			d3.select(this).append("tspan").text(targ.printDiscriminator());
		} else				
			drawAssocEndDesc(d.prop,this);
	
	
	})
	
	
	var reverseLinkTitles = svg.selectAll(".link_title_inv")
		.data(function(d) {
			return fdata.links.filter(function(d) {
				return (d.type=="G") || (d.type=="A" && getInverse(d.prop)!=null);
			})
		})
		.enter()
		.append("text")
		.attr("text-anchor","start") //at the end /start
		//.attr("dominant-baseline","central")
		.attr("class","link_title_inv")
	/*	.text(function(d) {
			if (d.type=="G") {
				if (d.prop)			
					return d.prop.printDescription(fdata.nodes[d.source].clazz,fdata.nodes[d.target].clazz);
			} else {		
				var inv = getInverse(d.prop);				
				return printAssocEndDesc(inv);
			}
		})*/;
	reverseLinkTitles.each(function (d) {
		if (d.type=="G") {
			if (d.prop)	{
				var tx=d.prop.printDescription(fdata.nodes[d.source].clazz,fdata.nodes[d.target].clazz);
				d3.select(this).append("tspan").text(tx);
			}		
		} else {
			var inv = getInverse(d.prop);		
			drawAssocEndDesc(inv,this)
		}
	});
	
	linkTitles.append("title")
          .text(function(d, i) { 
			if (d.type!="G")
				return printAssocEndDesc(d.prop);
		  });
	reverseLinkTitles.append("title")
          .text(function(d, i) { 
			if (d.type!="G")
				return printAssocEndDesc(getInverse(d.prop));
		  });
		
	d3.selectAll(".link_title").call(d3.drag()
	        .on("start", dragstartLink)
	        .on("drag", draggedLink)
	        .on("end", dragendLink));
	
	d3.selectAll(".link_title_inv").call(d3.drag()
	        .on("start", dragstartLink)
	        .on("drag", draggedLink)
	        .on("end", dragendLink));

	redrawLinks();	
	fdata.reposition=false;
		
}
function listPropData(node /*Node*/) {
	var d=node.clazz;
	var fdata = model.diagram;
	var linkProps  =fdata.links.map(function(d) {return d.prop});
	var props = d.properties.filter(function(prop) {
		var hasLink =  linkProps.indexOf(prop)>=0;
		var inv = getInverse(prop);
		if (inv!=null && !hasLink)
			hasLink = linkProps.indexOf(inv)>=0
	
		return  !hasLink;
	});
	props.sort(function(p1,p2) {
		var ret = p1.name < p2.name ? -1 : p1.name > p2.name;					
		var a1=getAssociation(p1),a2=getAssociation(p2);
		if (p1.pk && p2.pk) {
			return ret;
		}else if (p1.pk && !p2.pk) {
			return -1;
		}else if (!p1.pk && p2.pk) {
			return 1;
		} else if (a1!=null && a2!=null) {
			return ret;
		} else if (a1!=null && a2==null) {
			return 1;
		} else if (a1==null && a2!=null) {
			return -1;	
		}else {
			return ret;
		}			
	});
	
	return props;	
}
function refreshSVG() {
	var clazzBox = d3.selectAll(".node");
	// reset sizes...
	clazzBox.attr("width",5);
	clazzBox.selectAll("rect")
		.attr('width', 5)
		.attr('height', 5);
	clazzBox.selectAll(".text_title").attr('x',function(d) {
			return this.getBBox().width/2;
		})	
	clazzBox.selectAll(".title_line").attr('x1', 0)	
		.attr('x2', 5);
	clazzBox.selectAll(".closeClassIcon").attr('x',0);	
	clazzBox.attr("width",null);
	// 
	clazzBox.selectAll("rect")
		.attr('width', function(d) {
				return this.parentElement.getBBox().width;
				})
		.attr('height', function(d) {
			return this.parentElement.getBBox().height+sy/2;
		});
	redrawLinks();
}
function drawProperties(clazzBox) {
	var myData = new D3MyData(listPropData);
		
	//var myData = new D3MyData(group);
	var sel = clazzBox.selectAll(".text_property")
		.data(myData.getData(),myData.keyData());
	
	sel.exit().remove();	
	var entered = sel.enter()
		.append("text")		
		.attr('class', 'text_property')
		/*.text(function(d) {
			return getPropDesc(d)+" ";
			})		*/
		.attr("font-family", "sans-serif")
		.attr("font-size", "12px")
		.attr("fill", "black");
	entered.each(function(p) {  
		var parent = d3.select(this);		
		var pname = printPropDesc(p);
		
		var colMap = "";
		var colExtras = "";
		// mapping
		if (p.columnMapping!=null) {		
			var mainTab = p.parent.persistence.mainTable;
			colMap = " || "+printColumn(mainTab,p.columnMapping.columnDefinition);
			colExtras = printColumnExtra(mainTab,p.columnMapping.columnDefinition);
			
		}
		parent.append('tspan').text(pname); //.attr("class","main-desc")
		if (colMap) {
			parent.append('tspan')
				.attr("class","prop-mapping-desc")  //prop-mapping-desc-more
				.text(colMap)
				.append("title").text(colExtras); //
			parent.append('tspan')
				.attr("class","prop-mapping-desc-more")  //prop-mapping-desc-more
				.text("...")
				.append("title").text(colMap+colExtras); 
		}
		
	});
	
	entered.filter(function (d) { 
		return d.typeClass!=null;
	})
	.append("tspan")
	.attr("class","more-button")
	.on("mousedown",clickProperty)
	.text("[+]");
	
	clazzBox.selectAll(".text_property")
	.attr("x", function(d) {
		return 5;
	})
	.attr("y", function(d, i) {
		return ((i+1) *  PropHeight)+sy+2;
	});
	
	// reset sizes...
	clazzBox.attr("width",5);
	clazzBox.selectAll("rect")
		.attr('width', 5)
		.attr('height', 5);
	clazzBox.selectAll(".text_title").attr('x',function(d) {
			return this.getBBox().width/2;
		})	
	clazzBox.selectAll(".title_line").attr('x1', 0)	
		.attr('x2', 5);
	clazzBox.selectAll(".closeClassIcon").attr('x',0);	
	clazzBox.attr("width",null);
	// 
	clazzBox.selectAll("rect")
		.attr('width', function(d) {
				return this.parentElement.getBBox().width;
				})
		.attr('height', function(d) {
			return this.parentElement.getBBox().height+sy/2;
		});
}

function closeClass(clazz,idx) {
	var fdata = model.diagram;
	d3.event.stopPropagation();	
	//this idx will not work ! it is bound on "on('click')" definition
	idx = fdata.nodes.indexOf(clazz);
	var refClasses=new Set();
	//remove links
	fdata.links = fdata.links.filter(function(d) {
		if (d.source==idx) {
		 	refClasses.add(fdata.nodes[d.target]);		
			return false;	
		} else if (d.target==idx) {
			refClasses.add(fdata.nodes[d.source]);			
			return false;
		} else 
			return true;
		
	});
	refClasses.delete(clazz);
	for (var i=0;i<fdata.links.length;i++) {
		var l = fdata.links[i];
		if (l.target>idx)
			l.target=l.target-1;
		if (l.source>idx)
			l.source = l.source-1;
	}
	var elinks = svg.selectAll(".link")
		.data(fdata.links,function(d) {
			return fdata.links.indexOf(d);		
			
		})
		.exit();
	elinks.remove();
	svg.selectAll(".link_title").data(fdata.links,function(d,i) {
		return fdata.links.indexOf(d);		
		
	}).exit().remove();
	svg.selectAll(".link_title_inv").data(fdata.links,function(d,i) {
		return fdata.links.indexOf(d);		
		
	}).exit().remove();
	//--
	fdata.nodes.splice(idx,1);
	var exit = svg.selectAll('.node')
		.data(fdata.nodes,function(d,i) { 
			return fdata.nodes.indexOf(d);			
		}).exit();	
	
	exit.remove();
	
	drawProperties(svg.selectAll('.node').filter(function(d){ return refClasses.has(d);}));
	redrawLinks();
	if (currentClass==clazz) {
		selectClass(null);
	}
	
}
function getCoords(d/*link*/,clazzBox/*selection of .nodes*/) {
	var coords={x1:0,y1:0,x2:0,y2:0};
	var fdata = model.diagram;
	var src = clazzBox.nodes()[d.source], targ = clazzBox.nodes()[d.target];
	var sx=src.x.baseVal.value,sw = src.getBBox().width;
	var sy=src.y.baseVal.value,sh = src.getBBox().height;
	var tx=targ.x.baseVal.value,tw = targ.getBBox().width;
	var ty=targ.y.baseVal.value,th = targ.getBBox().height;
	var delta = Math.abs(tx-sx) - Math.abs(ty-sy);
	if (tx<sx && delta>0) {		
		coords.x1 = sx;
		coords.y1 = sy+sh/2;
	} else if (tx>sx+sw && delta>0) {
		coords.x1 = sx+sw;
		coords.y1 = sy+sh/2;		
	} else {
		coords.x1 = sx+sw/2;
		if (ty<sy)
			coords.y1= sy;
		else
			coords.y1= sy+sh;
	}
	delta = Math.abs(sx-tx) - Math.abs(sy-ty);
	
	if (sx<tx && delta>0) {
		coords.x2 = tx;
		coords.y2 = ty+th/2;
	} else if (sx>tx+tw && delta>0) {
		coords.x2 = tx+tw;
		coords.y2 = ty+th/2;		
	} else {
		coords.x2 = tx+tw/2;
		if (sy<ty)
			coords.y2= ty;
		else
			coords.y2= ty+th;
	}
	if (d.source==d.target) {
		coords.y2+=20;
		coords.x2+=10;
		coords.x1-=10;
	}
	for (i=0;i<fdata.links.length;i++) {
		var lnk = fdata.links[i];
		if (lnk!=d && lnk.target==d.target && lnk.coords)
			if ( lnk.coords.x2==coords.x2 && lnk.coords.y2==coords.y2) {
				if (d.source==d.target) {
					coords.y2+=20;
					coords.x2+=10;
					coords.x1-=10;	
				} else {
					var r=recalcConflict({x:coords.x2,y:coords.y2},tx,ty,tw,th)
					coords.x2=r[0];
					coords.y2=r[1];
				}				
				i=0;
			}
	}
	for (i=0;i<fdata.links.length;i++) {
		var lnk = fdata.links[i];
		if (lnk!=d && lnk.source==d.source && lnk.coords)
			if (lnk.coords.x1==coords.x1 &&  lnk.coords.y1==coords.y1 ) {
				var r = recalcConflict({x:coords.x1,y:coords.y1},sx,sy,sw,sh);	
				coords.x1=r[0];
				coords.y1=r[1];
				i=0;
			}
	}
	d.coords = coords;
	return coords;
}
function recalcConflict(coords,tx,ty,tw,th) {
	if (coords.y!=ty && coords.y!=ty+th) { //ty+th/2					
		if (coords.y<=(ty+th/2)) {
			var ny = ty+th-(coords.y-ty)/2;
			coords.y=ny;
		} else {
			var ny = ty+(ty+th-coords.y);
			coords.y=ny;
		}		
	} else {
		if (coords.x<=(tx+tw/2)) {
			var nx = tx+tw-(coords.x-tx)/2;						
			coords.x=nx;
		} else {
			var nx = tx+(tx+tw-coords.x);
			coords.x=nx;
		}	
	}
	return [coords.x,coords.y];
}
function redrawLinks() {
	svg.selectAll(".text_title").attr('x',function(d) {
		return this.parentElement.getBBox().width/2
		}
	);	
	svg.selectAll(".title_line").attr('x1', 0)	
	.attr('x2', function(d) {return this.parentElement.getBBox().width});
	
	svg.selectAll(".closeClassIcon").attr('x',function(d) {
		return this.parentElement.parentElement.getBBox().width -this.getBBox().width-2
	});	
	
	var clazzBox = svg.selectAll('.node');
	//clazzBox.select(".text_title").attr('x',function(d) {return this.parentElement.getBBox().width/2});
	var link = svg.selectAll(".link")		
		.attr("d", function (d) {
			var c=getCoords(d,clazzBox); 
			if (d.source==d.target) {
				return "M "+c.x1+","+c.y1+
					" L "+(c.x1)+","+(c.y2)+
					" L "+(c.x2)+","+(c.y2)+
					" L "+(c.x2)+","+c.y1;
			} else
				return "M "+c.x1+","+c.y1+" L "+c.x2+","+c.y2;
		});
		
	var texts = svg.selectAll(".link_title")
		.attr("x",function (d) {
			var c = getCoords(d,clazzBox);
			var x = c.x2; 	
			if (c.x1>c.x2)
				x+=4;
			else
				x-=4;;
			return x; 
			
		})
		.attr("y",function (d) {
			var c= getCoords(d,clazzBox);
			var y= c.y2; 
			if (c.y1>c.y2)
				y=y+this.getBBox().height+4;
			else 
				y=y-4;
			return y;
		})
		.attr("text-anchor",function (d) {
			var c=getCoords(d,clazzBox); 
			if (c.x1>c.x2)
				return "start";
			else
				return "end";
		});
	svg.selectAll(".link_title_inv")
		.attr("x",function (d) {			
			var c = getCoords(d,clazzBox);
			var x = c.x1; 	
			if (c.x1>c.x2)
				x-=4;
			else
				x+=4;;
			return x; 
		})
		.attr("y",function (d) {
			var c= getCoords(d,clazzBox);
			var y= c.y1; 
			if (c.y2>c.y1)
				y=y+this.getBBox().height+4;
			else 
				y=y-4;
			
			return y;
		})
		.attr("text-anchor",function (d) {
			var c=getCoords(d,clazzBox); 
			if (c.x1>c.x2)
				return "end";
			else
				return "start";
		});
}
function addBox(parent) {
	//var bbox = parent.node().getBBox();
	parent.append("rect")		
		.attr("stroke","black")
		.attr("stroke-width",1)
		.attr('x', 0) //bbox.x
		.attr('y', 0)
	/*	.attr('width', "100%")
		.attr('height', "100%")*/
		
		.attr('width', function(d) {
			return this.parentElement.getBBox().width;
			})
		.attr('height', function(d) {
			return this.parentElement.getBBox().height+sy/2;
		})
		.attr('class',function(d) {
			if (d.clazz.persistent)
				return 'persistent';
			else if (d.clazz.type=="InterfaceType")
				return "node-interface";
			else
				return 'transient';
		})
		.moveToBack();

}

function selectClass(node) {
	var closeFooter = footerElement==currentClass && currentClass!=null;
	currentClass = node;
	if (currentClass!=null) {
		d3.select("#openSourceBtn").attr("class","openbtn");
	} else 
		d3.select("#openSourceBtn").attr("class","hidden_btn");
	
	if (node!=null || closeFooter) {
		var footer = setFooter(node).text(function(d) {
			var inter = node.clazz.type=="InterfaceType" ? "Interface " : "";
			var pak = node.clazz.packageName!=null ? node.clazz.packageName+" " : "";
			return inter+pak+className(node.clazz);
			
		});
		if (node!=null && node.clazz.superClass) {	
			footer.append("button").attr("disabled","disabled").text("extends");
			
			if (hasInvisibleGeneralizations(node.clazz)) {
				footer.select("button").attr("disabled",null).text("extends").on("click",clickShowExtends);
			}
			
			footer.append("span").text(" "+node.clazz.superClass.name);
		}
		if (node!=null && node.clazz.implementInterfaces.length>0) {
			footer.append("span").text(" implements ");	
		
			footer.selectAll(".footer-interface")
				.data(node.clazz.implementInterfaces).enter()
				.append("span")
				.attr("class","footer-interface")
				.text(function(d,i) {
					var ret = d.name;					
					if (d.toInterface)
						ret = d.toInterface.name;
					if (i>0)
						ret=", "+ret;
					return ret;
				})
		}
			
		if (node!=null) {
			var tx=node.clazz.printDiscriminator();
			if (tx)
				tx="Discriminator: {"+tx+"} "	
		
			footer.append("button").text("source").on("click",openSource);	
		
			var myData = new D3MyData(node.clazz.specializations);
			var specs = footer.append("span").attr("id","footer-specializations").style("display","block");
			if (node.clazz.specializations.length>0)
				specs.text(tx+" known specializations: ");
			var foot = d3.select("#footer-specializations").selectAll("span").
				data(myData.getData(),myData.keyData())
				.enter().append("span")			
				.text(function (d,i) {				
					if (i>0)
						return ", ";
					return "";
				})
				.append("span")
				.on("mousedown",showSubClass)			
				.text(function (d) {
					return d.name;
				})
			
				;	
			var tr = footer.append("table").append("tr");
			var mets = tr.append("td").append("span").attr("id","footer-methods")
				.style("display","block");
			myData = new D3MyData(node.clazz.methods);
			if (node.clazz.methods.length>0)
				mets.text("Methods:")
				.append("span").attr("class","more-button").text("[+]")
				.on("mousedown",function (d) {
					if (this.innerHTML=="[+]") {
						this.innerHTML="[-]";
						d3.select("#footer-methods").selectAll(".footer-method").style("display","");
					} else {
						this.innerHTML="[+]";					
						d3.select("#footer-methods").selectAll(".footer-method").style("display","none");
					}
				});
				
			foot = d3.select("#footer-methods").selectAll("span")
				.data(myData.getData(),myData.keyData())
				.enter().append("span")
				.attr("class","footer-method")
				.style("display","none")
				.style("color",function(d) {
					switch(d.visibility) {
						case "PUBLIC":
							return "green";
							break;
						case "PROTECTED":
							return "blue";
							break;
						case "PRIVATE":
							return "red";
							break;
						case "PACKAGE":
							return "black";
							break;
						default:
							return "black";
					
					}
				})				
				.text(function (d,i) {				
					var ret =  d.name+"(";
					switch(d.visibility) {
						case "PUBLIC":
							ret="+"+ret;
							break;
						case "PROTECTED":
							ret="#"+ret;
							break;
						case "PRIVATE":
							ret="-"+ret;
							break;
						case "PACKAGE":
							ret="~"+ret;
							break;
						
					}
					d.params.forEach(function (p,i) {
						if (i>0)
							ret+=", "
						ret+=p;						
					});
					
					ret+=")";
					if (d.type)
						ret+=": "+d.type;
					return ret;
				});
			//--- overrides
			var overs = tr.append("td").append("span").attr("id","footer-overrides").style("display","block");
			myData = new D3MyData(node.clazz.overrides
					.filter(function(o) {return o.properties.length>0})
					.sort(function(pa,pb) {
						var a=pa.printPath();	
						var b=pb.printPath();
						if (a < b)
					    	return -1;
					  	if (a > b)
					    	return 1;
					  	return 0;
				 	})	
			);
			if (node.clazz.overrides.length>0)
				overs.text("Overrides:")
				.append("span").attr("class","more-button").text("[+]")
				.on("mousedown",function (d) {
					if (this.innerHTML=="[+]") {
						this.innerHTML="[-]";
						d3.select("#footer-overrides").selectAll(".footer-method").style("display","");
					} else {
						this.innerHTML="[+]";					
						d3.select("#footer-overrides").selectAll(".footer-method").style("display","none");
					}
				});
			foot = d3.select("#footer-overrides").selectAll("span")
				.data(myData.getData(),myData.keyData())
				.enter().append("span")
				.attr("class","footer-method")
				.style("display","none")
				.text(function (d,i) {	
					return d.printOverride(node.clazz);
				});
			
		}
	}
}

dragPos=[0,0];
function dragstarted(d) {
  selectClass(d);
  
  dragPos=[d3.event.x - this.x.baseVal.value,d3.event.y - this.y.baseVal.value];
  //console.log(dragPos);
  d3.select(this).classed("active", true);
}

function dragged(d) {
  
  var bbox = this.getBBox();//this.parentElement.getBBox();
 // d3.select(this).attr("x", d.x = d3.event.x - bbox.width/2).attr("y", d.y = d3.event.y - bbox.height/2);
  d3.select(this).attr("x", d.x = d3.event.x-dragPos[0] ).attr("y", d.y = d3.event.y -dragPos[1]);
  redrawLinks();
}

function dragended(d) {
  d3.select(this).classed("active", false);
}


function setFooter(e) {
	footerElement = e;
	var group = e==null ? [] : 	[e];
	var myData = new D3MyData(group);
	var foot = d3.select(".footer").data(myData.getData(),myData.keyData());
	foot.exit().remove();
	var ret = foot.enter()
		.append("div")
		.attr("class","footer")
		.on("click",function(e) {
			if (d3.event.target==this)		
				d3.selectAll(".footer").data([]).exit().remove();
		})		
		
	return ret;
}
function selectElementProp(e,isInverse) {
	if (isInverse)	
		e = getInverse(e);
	setFooter(e).text(function(d) {
		if (d instanceof MGeneralization)
			return "";
	
		return printAssocEndDesc(d);
		
	});	
}
function dragstartLink(d) {	
	var m=this.attributes["text-anchor"].value=="start" ? 0 : 1;
	dragPos=[d3.event.x - (this.getBBox().x+this.getBBox().width*m),d3.event.y - (this.getBBox().y+this.getBBox().height)];
  	//console.log(dragPos);
  	d3.select(this).classed("active", true); 
  	svg.selectAll(".link").filter(function(dv) {return dv==d}).classed("active_link", true);
  	//svg.selectAll("#link_"+fdata.links.indexOf(d)).classed("active_link", true); 
  	selectElementProp(d.prop,d3.select(this).classed("link_title_inv"));
}  			
function draggedLink(d) {  
  
  d3.select(this).attr("x", d.x = d3.event.x-dragPos[0] ).attr("y", d.y = d3.event.y -dragPos[1]);
  
}

function dragendLink(d) {
  d3.select(this).classed("active", false);
  svg.selectAll(".link").filter(function(dv) {return dv==d}).classed("active_link", false);
  //svg.selectAll("#link_"+fdata.links.indexOf(d)).classed("active_link", false); 
}

</script>
</body>
</html>